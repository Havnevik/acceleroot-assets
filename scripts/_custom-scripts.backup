
(function () {
  const dragThreshold = 5;
  let isDragging = false;

  function enableImageComparisons() {
    document.querySelectorAll('.image-comparison').forEach(container => {
      const figure = container.querySelector('figure');
      const handle = container.querySelector('.handle');
      const labelStart = container.querySelector('.label-start');
      const labelResult = container.querySelector('.label-result');
      if (!figure) return;

      function setPosition(clientX) {
        const rect = figure.getBoundingClientRect();
        let percent = ((clientX - rect.left) / rect.width) * 100;
        percent = Math.max(0, Math.min(100, percent));
        container.style.setProperty('--position', `${percent}%`);
        if (handle) handle.style.left = `${percent}%`;
        if (labelStart) labelStart.style.opacity = percent < 10 ? '0' : '1';
        if (labelResult) labelResult.style.opacity = percent > 90 ? '0' : '1';
      }

      let isDragging = false;
      const onMove = e => isDragging && setPosition(e.clientX);
      const end = () => {
        isDragging = false;
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', end);
      };

      container.addEventListener('pointerdown', e => {
        isDragging = true;
        setPosition(e.clientX);
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', end);
      });

      container.addEventListener('touchstart', e => {
        if (e.touches.length === 1) setPosition(e.touches[0].clientX);
      }, { passive: true });

      container.addEventListener('touchmove', e => {
        if (e.touches.length === 1) setPosition(e.touches[0].clientX);
      }, { passive: true });
    });
  }

  function initHorizontalSlider(wrapperSelector, scrollSelector, leftBtnSelector, rightBtnSelector) {
    const container = document.querySelector(wrapperSelector);
    const scrollContainer = container?.querySelector(scrollSelector);
    const leftBtn = container?.querySelector(leftBtnSelector);
    const rightBtn = container?.querySelector(rightBtnSelector);
    if (!scrollContainer || !leftBtn || !rightBtn) return;

      
    const updateArrows = () => {
      const max = scrollContainer.scrollWidth - scrollContainer.clientWidth;
      leftBtn.style.display = scrollContainer.scrollLeft <= 1 ? 'none' : 'block';
      rightBtn.style.display = scrollContainer.scrollLeft >= max - 1 ? 'none' : 'block';
    };

    leftBtn.addEventListener('click', () => {
      const card = scrollContainer.querySelector('article');
      const w = card?.offsetWidth || 300;
      scrollContainer.scrollBy({ left: -(w + 24), behavior: 'smooth' });
    });

    rightBtn.addEventListener('click', () => {
      const card = scrollContainer.querySelector('article');
      const w = card?.offsetWidth || 300;
      scrollContainer.scrollBy({ left: w + 24, behavior: 'smooth' });
    });

    scrollContainer.addEventListener('scroll', () => requestAnimationFrame(updateArrows));

    // Drag med mus
    let startX = 0, scrollStart = 0;
    scrollContainer.addEventListener('mousedown', e => {
      isDragging = true;
      scrollContainer.classList.add('dragging');
      startX = e.pageX - scrollContainer.offsetLeft;
      scrollStart = scrollContainer.scrollLeft;
    });

    scrollContainer.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const x = e.pageX - scrollContainer.offsetLeft;
      scrollContainer.scrollLeft = scrollStart - (x - startX);
    });

    ['mouseup', 'mouseleave'].forEach(evt => {
      scrollContainer.addEventListener(evt, () => {
        isDragging = false;
        scrollContainer.classList.remove('dragging');
      });
    });

    updateArrows();
  }

  function enableModalCards() {
    const scrollContainer = document.querySelector('.modal-cards-scroll');
    const originalContainer = document.querySelector('.acceleroot-modal');
    if (!scrollContainer || !originalContainer) return;

    // Bygg overlay og legg til i DOM
    const overlay = document.createElement('div');
    overlay.id = 'modal-overlay';
    overlay.setAttribute('role', 'dialog');
    overlay.setAttribute('aria-modal', 'true');
    overlay.setAttribute('tabindex', '-1');
    document.body.appendChild(overlay);

    let lastFocused = null;

    const trapFocus = (el) => {
      const f = el.querySelectorAll('a, button, [tabindex]:not([tabindex="-1"])');
      const first = f[0], last = f[f.length - 1];
      el.addEventListener('keydown', e => {
        if (e.key !== 'Tab') return;
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      });
    };

    const closeModal = () => {
      const section = overlay.querySelector('section[data-block-id]');
      if (section) {
        section.style.display = 'none';
        originalContainer.appendChild(section);
      }
      overlay.classList.remove('active');
      document.body.style.overflow = '';
      lastFocused?.focus();
    };

    const openModal = (blockId) => {
      const section = originalContainer.querySelector(`section[data-block-id="${blockId}"]`);
      if (!section) return;

      lastFocused = document.activeElement;
      const modalInner = document.createElement('div');
      modalInner.className = 'modal-inner';

      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.className = 'modal-close-btn';
      closeBtn.setAttribute('aria-label', 'Lukk');
      modalInner.appendChild(closeBtn);

      section.style.display = 'block';
      modalInner.appendChild(section);
      overlay.innerHTML = '';
      overlay.appendChild(modalInner);
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      section.setAttribute('tabindex', '-1');
      section.focus();
      trapFocus(overlay);

      closeBtn.addEventListener('click', closeModal);
    };

    overlay.addEventListener('click', e => {
      if (e.target === overlay) closeModal();
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && overlay.classList.contains('active')) closeModal();
    });

    scrollContainer.querySelectorAll('article.has-modal').forEach(article => {
      let clickStart = { x: 0, y: 0 };
      article.addEventListener('mousedown', e => {
        clickStart = { x: e.clientX, y: e.clientY };
      });
      article.addEventListener('click', e => {
        if (isDragging) return;
        const dist = Math.hypot(e.clientX - clickStart.x, e.clientY - clickStart.y);
        if (dist > dragThreshold) return;
        openModal(article.id);
      });
    });
  }

  function initAll() {
    enableImageComparisons();
    initHorizontalSlider('.testimonial-slider', '.testimonial-scroll', '.testimonial-slider-arrow.left', '.testimonial-slider-arrow.right');
    initHorizontalSlider('.modal-cards-slider', '.modal-cards-scroll', '.modal-cards-slider-arrow.left', '.modal-cards-slider-arrow.right');
    enableModalCards();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
})();
